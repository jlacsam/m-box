<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>m-box REST APIs</title>
    {% load static %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/json-formatter/0.7.2/json-formatter.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        label {
            min-width: 150px;
            font-weight: bold;
            margin: 0;
        }
        select, input, textarea {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .parameter-group {
            padding: 15px;
            margin: 5px 0;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .parameter-group h3 {
            margin-top: 0;
            margin-bottom: 15px;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 15px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .request {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
            white-space: pre-wrap;
        }
        .response {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
            white-space: pre-wrap;
        }
        .api-info {
            margin: 20px 0;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 4px;
        }
        .error {
            color: red;
            margin-top: 5px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #666;
        }
        /* Special handling for textarea container */
        .textarea-container {
            display: flex;
            gap: 10px;
        }
        .textarea-container label {
            min-width: 150px;
            padding-top: 8px;
        }
        .textarea-container textarea {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>m-box REST APIs</h1>

        <div class="parameter-group">
            <h3>Common Headers</h3>
            <div class="form-group">
                <label for="csrfToken">CSRF Token</label>
                <input type="text" id="csrfToken" required>
            </div>
            <div class="form-group">
                <label for="subscriptionID">Subscription-ID</label>
                <input type="text" id="subscriptionID" required>
            </div>
            <div class="form-group">
                <label for="clientSecret">Client-Secret</label>
                <input type="text" id="clientSecret" required>
            </div>
        </div>

        <div class="form-group">
            <label for="apiSelect">Select API</label>
            <select id="apiSelect">
                <option value="">Loading APIs...</option>
            </select>
        </div>

        <div id="apiDetails" class="api-info" style="display: none;">
            <div id="description"></div>
            <div id="endpoint"></div>
            <div id="method"></div>
            <div id="outputs"></div>
            <div id="status"></div>
        </div>

        <div id="headerParams" class="parameter-group"></div>
        <div id="urlParams" class="parameter-group"></div>
        <div id="bodySection" class="parameter-group"></div>

        <button id="submitBtn" onclick="submitRequest()">Submit</button>

        <div id="request" class="request" style="display: none;"></div>
        <div id="response" class="response" style="display: none;"></div>
    </div>

    <script src="{% static 'js/utils.js' %}"></script>
    <script>
        const SUBSCRIPTION_ID = '00000000';
        const CLIENT_SECRET = '00000000';
        const commonHeaders = ['CSRF Token','Subscription-ID','Client-Secret'];

        let apiData = [];

        // Load API definitions from JSON file
        function loadApiDefinitions() {
            const csrftoken = getCookie('csrftoken');
            fetch('/static/data/endpoints.json', {
                method: 'GET',
                headers: {
                    'Subscription-ID': SUBSCRIPTION_ID,
                    'Client-Secret': CLIENT_SECRET,
                    'X-CSRFToken': csrftoken,
                }
            })
            .then(response => response.json())
            .then(data => {
                apiData = data;
                initializeApiSelect();
            })
            .catch(error => {
                console.error('Error loading API definitions:', error);
                document.getElementById('apiSelect').innerHTML = 
                    '<option value="">Error loading APIs. Please refresh the page.</option>';
            });
        }

        // Initialize the API select dropdown
        function initializeApiSelect() {
            const apiSelect = document.getElementById('apiSelect');
            apiSelect.innerHTML = '<option value="">Select an API...</option>' +
                apiData.map((api, index) => 
                    `<option value="${index}">${api.name}</option>`
                ).join('');

            const csrfToken = document.getElementById('csrfToken');
            csrfToken.value = getCookie('csrftoken');

            const subscriptionID = document.getElementById('subscriptionID');
            subscriptionID.value = SUBSCRIPTION_ID;

            const clientSecret = document.getElementById('clientSecret');
            clientSecret.value = CLIENT_SECRET;
        }

        // Initialize the page
        window.onload = function() {
            const apiSelect = document.getElementById('apiSelect');
            apiSelect.addEventListener('change', updateApiDetails);
            loadApiDefinitions();
        };

        function updateApiDetails() {
            const selectedApi = apiData[document.getElementById('apiSelect').value];
            if (!selectedApi) {
                document.getElementById('apiDetails').style.display = 'none';
                return;
            }

            // Show API details
            document.getElementById('apiDetails').style.display = 'block';
            document.getElementById('description').innerHTML = `<strong>Description:</strong> ${selectedApi.description}`;
            document.getElementById('endpoint').innerHTML = `<strong>Endpoint:</strong> ${sanitizeHtml(selectedApi.endpoint)}`;
            document.getElementById('method').innerHTML = `<strong>Method:</strong> ${selectedApi.method}`;
            document.getElementById('outputs').innerHTML = `<strong>Outputs:</strong> ${JSON.stringify(selectedApi.outputs, null, 2)}`;
            document.getElementById('status').innerHTML = `<strong>Status:</strong> ${selectedApi.status}`;

            // Update headers section
            const headerParamsDiv = document.getElementById('headerParams');
            headerParamsDiv.innerHTML = '<h3>Headers</h3>';
            selectedApi.headers.forEach(header => {
                if (!commonHeaders.includes(header)) {
                    headerParamsDiv.innerHTML += `
                        <div class="form-group">
                            <label for="header_${header}">${header}</label>
                            <input type="text" id="header_${header}" required>
                        </div>
                    `;
                }
            });

            // Update parameters section
            const urlParamsDiv = document.getElementById('urlParams');
            urlParamsDiv.innerHTML = '<h3>Parameters</h3>';
            selectedApi.parameters.forEach(param => {
                urlParamsDiv.innerHTML += `
                    <div class="form-group">
                        <label for="param_${param.name}">${param.name} (${param.type}):</label>
                        <input type="text" id="param_${param.name}" required>
                    </div>
                `;
            });

            // Update body section
            const bodySection = document.getElementById('bodySection');
            if (selectedApi.body) {
                bodySection.innerHTML = `
                    <h3>Request Body</h3>
                    <div class="textarea-container">
                        <label for="requestBody">Body</label>
                        <textarea id="requestBody" rows="5">${JSON.stringify(selectedApi.body, null, 2)}</textarea>
                    </div>
                `;
                bodySection.style.display = 'block';
            } else {
                bodySection.style.display = 'none';
            }
        }

        function submitRequest() {
            const selectedApi = apiData[document.getElementById('apiSelect').value];
            if (!selectedApi) return;

            // Collect headers
            const headers = {};
            headers['X-CSRF-Token'] = document.getElementById('csrfToken').value;
            headers['Subscription-ID'] = document.getElementById('subscriptionID').value;
            headers['Client-Secret'] = document.getElementById('clientSecret').value;
            selectedApi.headers.forEach(header => {
                if (!commonHeaders.includes(header)) {
                    headers[header] = document.getElementById(`header_${header}`).value;
                }
            });

            // Build endpoint URL by replacing parameters
            let endpoint = selectedApi.endpoint.split('/')[0];
            selectedApi.parameters.forEach(param => {
                const value = document.getElementById(`param_${param.name}`).value;
                const placeholder = `<int:${param.name.toLowerCase().replace(' ', '_')}>`;
                endpoint = endpoint.replace(placeholder, value);
            });

            // Collect body if needed
            const body = selectedApi.body ? 
                document.getElementById('requestBody').value : null;

            // Display what would be sent
            const requestDetails = {
                method: selectedApi.method,
                endpoint: endpoint,
                headers: headers,
                body: body ? JSON.parse(body) : null
            };
            document.getElementById('request').style.display = 'block';
            document.getElementById('request').innerHTML = 
                `<h3>Request Details:</h3>` +
                `<pre>${JSON.stringify(requestDetails, null, 2)}</pre>`;

            // Fetch endpoint
            fetch('/api/' + endpoint + '/', requestDetails)
            .then(response => response.json())
            .then(data => {
                document.getElementById('response').style.display = 'block';
                document.getElementById('response').innerHTML = 
                    `<h3>Response:</h3>` +
                    `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            })
            .catch(error => {
                document.getElementById('response').style.display = 'block';
                document.getElementById('response').innerHTML = 
                    `<h3>Error:</h3>` +
                    `<pre>${error}</pre>`;
            });
        }
    </script>
</body>
</html>
