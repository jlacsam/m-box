<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>m-box REST APIs</title>
    {% load static %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/json-formatter/0.7.2/json-formatter.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 100%;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-top: 10px;
            margin-bottom: 15px;
        }
        h4 {
            color: #333;
            text-align: center;
            margin-top: 10px;
            margin-bottom: 15px;
        }
        .form-group {
            margin-bottom: 0px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        label {
            min-width: 120px;
            font-weight: bold;
            margin: 0;
        }
        select, input, textarea {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .parameter-group {
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .parameter-group h3 {
            margin-top: 0;
            margin-bottom: 5px;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 15px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .request {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            white-space: pre-wrap;
        }
        .response {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            white-space: pre-wrap;
        }
        .api-info {
            margin: 10px 0;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 4px;
        }
        .error {
            color: red;
            margin-top: 5px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #666;
        }
        /* Special handling for textarea container */
        .textarea-container {
            display: flex;
            gap: 10px;
        }
        .textarea-container label {
            min-width: 150px;
            padding-top: 8px;
        }
        .textarea-container textarea {
            flex: 1;
        }
        .file-input-container {
            margin: 10px 0;
        }
        .file-input-container label {
            display: block;
            margin-bottom: 5px;
        }
        .file-details {
            margin-top: 5px;
            font-size: 0.9em;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>m-box REST APIs</h1>
        <h4>USER: {{user.username}}</h4>
        <div class="parameter-group">
            <h3>Select API</h3>
            <div class="form-group">
                <select id="apiSelect">
                    <option value="">Loading APIs...</option>
                </select>
            </div>
        </div>

        <div id="apiDetails" class="api-info" style="display: none;">
            <div id="description"></div>
            <div id="endpoint"></div>
            <div id="method"></div>
            <div id="outputs"></div>
            <div id="status"></div>
        </div>

        <div class="parameter-group">
            <h3>Common Headers</h3>
            <div class="form-group">
                <label for="csrfToken">CSRF Token</label>
                <input type="text" id="csrfToken" required>
                <label for="subscriptionID">Subscription-ID</label>
                <input type="text" id="subscriptionID" required>
                <label for="clientSecret">Client-Secret</label>
                <input type="text" id="clientSecret" required>
            </div>
        </div>

        <div id="headerParams" class="parameter-group"></div>
        <div id="urlParams" class="parameter-group"></div>

    <div id="bodySection" class="parameter-group">
        <!-- This section will be dynamically updated based on content type -->
    </div>

    <button id="submitBtn" onclick="submitRequest()">Submit</button>

    <div id="request" class="request" style="display: none;"></div>
    <div id="response" class="response" style="display: none;"></div>

    <script src="{% static 'js/utils.js' %}"></script>
    <script>
        const SUBSCRIPTION_ID = '00000000';
        const CLIENT_SECRET = '00000000';
        const commonHeaders = ['CSRF Token','Subscription-ID','Client-Secret'];

        let apiData = [];

        // Load API definitions from JSON file
        function loadApiDefinitions() {
            const csrftoken = getCookie('csrftoken');
            fetch('/static/data/endpoints.json', {
                method: 'GET',
                headers: {
                    'Subscription-ID': SUBSCRIPTION_ID,
                    'Client-Secret': CLIENT_SECRET,
                    'X-CSRFToken': csrftoken,
                }
            })
            .then(response => response.json())
            .then(data => {
                apiData = data;
                initializeApiSelect();
            })
            .catch(error => {
                console.error('Error loading API definitions:', error);
                document.getElementById('apiSelect').innerHTML = 
                    '<option value="">Error loading APIs. Please refresh the page.</option>';
            });
        }

        // Initialize the API select dropdown
        function initializeApiSelect() {
            const apiSelect = document.getElementById('apiSelect');
            apiSelect.innerHTML = '<option value="">Select an API...</option>' +
                apiData.map((api, index) => 
                    `<option value="${index}">${api.name}</option>`
                ).join('');

            const csrfToken = document.getElementById('csrfToken');
            csrfToken.value = getCookie('csrftoken');

            const subscriptionID = document.getElementById('subscriptionID');
            subscriptionID.value = SUBSCRIPTION_ID;

            const clientSecret = document.getElementById('clientSecret');
            clientSecret.value = CLIENT_SECRET;
        }

        // Initialize the page
        window.onload = function() {
            const apiSelect = document.getElementById('apiSelect');
            apiSelect.addEventListener('change', updateApiDetails);
            loadApiDefinitions();
        };

        function updateApiDetails() {
            const selectedApi = apiData[document.getElementById('apiSelect').value];
            if (!selectedApi) {
                document.getElementById('apiDetails').style.display = 'none';
                return;
            }

            // Show API details
            document.getElementById('apiDetails').style.display = 'block';
            document.getElementById('description').innerHTML = `<strong>Description:</strong> ${selectedApi.description}`;
            document.getElementById('endpoint').innerHTML = `<strong>Endpoint:</strong> ${sanitizeHtml(selectedApi.endpoint)}`;
            document.getElementById('method').innerHTML = `<strong>Method:</strong> ${selectedApi.method}`;
            document.getElementById('outputs').innerHTML = `<strong>Outputs:</strong> ${JSON.stringify(selectedApi.outputs, null, 2)}`;
            document.getElementById('status').innerHTML = `<strong>Status:</strong> ${selectedApi.status}`;

            // Update headers section
            const headerParamsDiv = document.getElementById('headerParams');
            headerParamsDiv.innerHTML = '<h3>Headers</h3>';
            selectedApi.headers.forEach(header => {
                const [key, value] = Object.entries(header)[0];
                if (!commonHeaders.includes(key)) {
                    headerParamsDiv.innerHTML += `
                        <div class="form-group">
                            <label for="header_${header}">${key}</label>
                            <input type="text" id="header_${key}" value="${value}"required>
                        </div>
                    `;
                }
            });

            // Update parameters section
            const urlParamsDiv = document.getElementById('urlParams');
            urlParamsDiv.innerHTML = '<h3>Parameters</h3>';
            selectedApi.parameters.forEach(param => {
                urlParamsDiv.innerHTML += `
                    <div class="form-group">
                        <label for="param_${param.name}">${param.name} (${param.type}):</label>
                        <input type="text" id="param_${param.name}" required>
                    </div>
                `;
            });

            // Update body section based on content type
            const bodySection = document.getElementById('bodySection');
            if (selectedApi.body) {
                const contentType = selectedApi.body.content_type || 'application/json';
                
                if (contentType === 'multipart/form-data') {
                    bodySection.innerHTML = `
                        <h3>File Upload</h3>
                        <div class="file-input-container">
                            <label for="fileInput">Select File</label>
                            <input type="file" id="fileInput" required>
                            <div id="fileDetails" class="file-details"></div>
                        </div>
                    `;
                    
                    // Add file input change listener
                    document.getElementById('fileInput').addEventListener('change', function(e) {
                        const file = e.target.files[0];
                        if (file) {
                            document.getElementById('fileDetails').innerHTML = `
                                Selected file: ${file.name}<br>
                                Size: ${(file.size / 1024).toFixed(2)} KB<br>
                                Type: ${file.type}
                            `;
                        }
                    });
                } else {
                    // Default JSON body handling
                    bodySection.innerHTML = `
                        <h3>Request Body</h3>
                        <div class="textarea-container">
                            <label for="requestBody">Body</label>
                            <textarea id="requestBody" rows="5">${JSON.stringify(selectedApi.body, null, 2)}</textarea>
                        </div>
                    `;
                }
                bodySection.style.display = 'block';
            } else {
                bodySection.style.display = 'none';
            }

            // Hide request and response sections
            document.getElementById('request').style.display = 'none';
            document.getElementById('response').style.display = 'none';
        }

        function submitRequest() {
            const selectedApi = apiData[document.getElementById('apiSelect').value];
            if (!selectedApi) return;

            // Collect headers
            const headers = {
                'X-CSRFToken': document.getElementById('csrfToken').value,
                'Subscription-ID': document.getElementById('subscriptionID').value,
                'Client-Secret': document.getElementById('clientSecret').value
            };

            // Build endpoint URL
            let endpoint = selectedApi.endpoint;
            selectedApi.parameters.forEach(param => {
                const value = document.getElementById(`param_${param.name}`).value;
                const placeholder = `<${param.type.toLowerCase()}:${param.name.toLowerCase().replace(/ /g, '_')}>`;
                endpoint = endpoint.replace(placeholder, value);
            });

            // Add custom headers
            let contentType = 'text/plain';
            selectedApi.headers.forEach(header => {
                const [key, value] = Object.entries(header)[0];
                if (key.toLowerCase() === 'content-type') {
                    contentType = value.toLowerCase();
                }
                if (!commonHeaders.includes(key)) {
                    headers[key] = document.getElementById(`header_${key}`).value;
                }
            });

            // Prepare fetch options
            const fetchOptions = {
                method: selectedApi.method,
                headers: headers,
                credentials: 'include'
            };

            // Handle different content types
            if (selectedApi.body) {
                if (contentType === 'multipart/form-data') {
                    const formData = new FormData();
                    const fileInput = document.getElementById('fileInput');
                    
                    if (fileInput.files.length > 0) {
                        formData.append('file', fileInput.files[0]);
                        // Don't set Content-Type header - browser will set it with boundary
                        delete headers['Content-Type'];
                        fetchOptions.body = formData;
                    } else {
                        document.getElementById('response').style.display = 'block';
                        document.getElementById('response').innerHTML = 
                            `<h3>Error:</h3><pre>Please select a file to upload</pre>`;
                        return;
                    }
                } else if (contentType === 'application/json') {
                    // Handle JSON body
                    try {
                        const bodyContent = document.getElementById('requestBody').value;
                        fetchOptions.body = bodyContent.trim();
                    } catch (error) {
                        document.getElementById('response').style.display = 'block';
                        document.getElementById('response').innerHTML = 
                            `<h3>Error:</h3><pre>Invalid JSON in request body: ${error.message}</pre>`;
                        return;
                    }
                } else if (contentType === 'text/plain') {
                    try {
                        const bodyContent = document.getElementById('requestBody').value;
                        fetchOptions.body = bodyContent.trim();
                    } catch (error) {
                        document.getElementById('response').style.display = 'block';
                        document.getElementById('response').innerHTML = 
                            `<h3>Error:</h3><pre>${error.message}</pre>`;
                        return;
                    }
                }
            }

            fetchOptions.headers = headers;

            // Display request details
            const requestDetails = {
                method: selectedApi.method,
                endpoint: endpoint,
                headers: headers
            };

            if (selectedApi.body && contentType === 'multipart/form-data') {
                const fileInput = document.getElementById('fileInput');
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    requestDetails.file = {
                        name: file.name,
                        size: file.size,
                        type: file.type
                    };
                }
            } else if (selectedApi.body && contentType === 'application/json') {
                requestDetails.body = JSON.parse(document.getElementById('requestBody').value);
            } else if (selectedApi.body && contentType === 'text/plain') {
                requestDetails.body = document.getElementById('requestBody').value;
            }

            document.getElementById('request').style.display = 'block';
            document.getElementById('request').innerHTML = 
                `<h3>Request Details:</h3>` +
                `<pre>${JSON.stringify(requestDetails, null, 2)}</pre>`;

            // Make the API call
            fetch('/api/' + endpoint, fetchOptions)
                .then(response => {
                    if (!response.ok) {
                        return Promise.all([response.json(), response]).then(([data, response]) => {
                            throw new Error(`${response.status}:${response.statusText}:${JSON.stringify(data)}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    document.getElementById('response').style.display = 'block';
                    document.getElementById('response').innerHTML = 
                        `<h3>Response:</h3>` +
                        `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                })
                .catch(error => {
                    document.getElementById('response').style.display = 'block';
                    document.getElementById('response').innerHTML = 
                        `<h3>Error:</h3>` +
                        `<pre>${error.message}</pre>`;
                });
        }
    </script>
</body>
</html>
